--%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  Vistas  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
--1. Mostrar todos los pedidos de un negocio
CREATE OR REPLACE VIEW V_PEDIDOS_NEGOCIO (NO_PEDIDO,FECHA,NEGOCIO,ESTATUS)AS
SELECT  PEDIDO_ID,PEDIDO_FECHA_CREACION,NEGOCIO_NOMBRE,PEDIDO_ESTATUS
FROM PEDIDO
JOIN DETALLE_PEDIDO ON DP_PEDIDO_ID = PEDIDO_ID
JOIN PLATILLO ON DP_PLATILLO_ID = PLATILLO_ID
JOIN NEGOCIO ON PLATILLO_NEGOCIO_ID = NEGOCIO_ID 
WHERE UPPER(NEGOCIO_NOMBRE) LIKE UPPER('COCINA ECONOMICA');

SELECT * FROM V_PEDIDOS_NEGOCIO;

--2. Mostrar todos los pedidos entregados por un repartidor
CREATE OR REPLACE VIEW V_PEDIDOS_REPARTIDOR (NO_PEDIDO,FECHA,REPARTIDOR,ESTATUS)AS
SELECT PEDIDO_ID,PEDIDO_FECHA_CREACION,REPARTIDOR_NOMBRE|| ' ' ||REPARTIDOR_APELLIDOP|| ' ' ||REPARTIDOR_APELLIDOM,PEDIDO_ESTATUS
FROM PEDIDO
JOIN REPARTIDOR ON PEDIDO_REPARTIDOR_ID = REPARTIDOR_ID
JOIN DETALLE_PEDIDO ON DP_PEDIDO_ID = PEDIDO_ID
JOIN PLATILLO ON DP_PLATILLO_ID = PLATILLO_ID
WHERE UPPER(REPARTIDOR_NOMBRE) LIKE UPPER('DANIEL') AND UPPER(REPARTIDOR_APELLIDOP) LIKE UPPER('ROSAS') AND UPPER(REPARTIDOR_APELLIDOM) LIKE UPPER('DIAZ');

SELECT * FROM V_PEDIDOS_REPARTIDOR;

--3. ¿Cuál es el negocio que vende más?
CREATE OR REPLACE VIEW V_NEGOCIO_GANANCIAS (NEGOCIO,COSTO_TOTAL_PEDIDOS,GANANCIA_REPARTIDORES,GANANCIA_NEGOCIO)AS
SELECT NEGOCIO_NOMBRE,SUM(((PLATILLO_COSTO*DP_CANTIDAD_PLATILLO))+PEDIDO_COSTO_ENVIO),SUM((((PLATILLO_COSTO*DP_CANTIDAD_PLATILLO))+PEDIDO_COSTO_ENVIO)*.20),SUM((((PLATILLO_COSTO*DP_CANTIDAD_PLATILLO))+PEDIDO_COSTO_ENVIO)-((((PLATILLO_COSTO*DP_CANTIDAD_PLATILLO))+PEDIDO_COSTO_ENVIO)*.20))AS GANANCIA_NEGOCIO
FROM NEGOCIO 
JOIN PLATILLO ON PLATILLO_NEGOCIO_ID = NEGOCIO_ID
JOIN DETALLE_PEDIDO ON DP_PLATILLO_ID = PLATILLO_ID
JOIN PEDIDO ON DP_PEDIDO_ID = PEDIDO_ID
GROUP BY NEGOCIO_NOMBRE
ORDER BY GANANCIA_NEGOCIO DESC;

SELECT * FROM V_NEGOCIO_GANANCIAS;

--4. ¿Cuál es el repartidor con más entregas?
CREATE OR REPLACE VIEW V_REPARTIDOR_ENTREGAS (REPARTIDOR,NO_ENTREGAS)AS
SELECT REPARTIDOR_NOMBRE|| ' ' ||REPARTIDOR_APELLIDOP|| ' ' ||REPARTIDOR_APELLIDOM, COUNT(PEDIDO_ID) AS NO_ENTREGAS
FROM REPARTIDOR 
JOIN PEDIDO ON PEDIDO_REPARTIDOR_ID = REPARTIDOR_ID
GROUP BY REPARTIDOR_NOMBRE, REPARTIDOR_APELLIDOP,REPARTIDOR_APELLIDOM
ORDER BY NO_ENTREGAS DESC;

SELECT * FROM V_REPARTIDOR_ENTREGAS;

--5. Mostrar la cantidad de pedidos por alcaldía
CREATE OR REPLACE VIEW V_PEDIDOS_ALCALDIA (MUN_ALC,NO_PEDIDOS)AS
SELECT DIRECCION_MUNICIPIO_ALCALDIA, COUNT(PEDIDO_ID) AS NO_PEDIDOS
FROM PEDIDO
JOIN CLIENTE ON PEDIDO_CLIENTE_ID = CLIENTE_ID
JOIN DIRECCION ON CLIENTE_DIRECCION_ID = DIRECCION_ID
GROUP BY DIRECCION_MUNICIPIO_ALCALDIA
ORDER BY NO_PEDIDOS DESC;

SELECT * FROM V_PEDIDOS_ALCALDIA;
